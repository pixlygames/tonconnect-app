<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ton_connect</title>
    <script src="https://unpkg.com/@tonconnect/ui@1.0.0-beta.5/dist/tonconnect-ui.min.js"></script>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <script src="index.js"></script>
    <style>
        /* Add this style to make font Helvetica and text white */
        body {
            font-family: 'Helvetica', sans-serif;
            color: white;
        }
    </style>
</head>
<body style="padding: 10px; margin: 0;">
    <div class="OurDiv">
        <div id="connect-button-root" style="width: fit-content; margin-left: auto"></div>
        <div id="nft-info" style="margin-top: 20px;"></div>

        <script>
            const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://raw.githubusercontent.com/pixlygames/tonconnect-app/refs/heads/main/tonconnect-manifest.json',
                buttonRootId: 'connect-button-root'
            });

            tonConnectUI.onStatusChange(async (wallet) => {
                if (wallet) {
                    const walletAddress = wallet.account.address;
                    
                    // Send wallet address to server to fetch NFTs
                    $.post('https://ton_connect/fetchNFTs', JSON.stringify({
                        walletAddress: walletAddress
                    })).done(function(nftInfo) {
                        if (nftInfo && nftInfo.success) {
                            displayNFTs(nftInfo.nfts);
                            
                            // Link wallet and NFTs
                            $.post('https://ton_connect/linkWallet', JSON.stringify({
                                walletAddress: walletAddress,
                                nfts: nftInfo.nfts
                            })).done(function(response) {
                                console.log('Wallet linked successfully:', response);
                            }).fail(function(error) {
                                console.error('Error linking wallet:', error);
                            });
                        } else {
                            console.error('Error fetching NFTs:', nftInfo.error);
                            document.getElementById('nft-info').innerHTML = '<p>Error fetching NFTs. Please try again.</p>';
                        }
                    }).fail(function(error) {
                        console.error('Error fetching NFTs:', error);
                        document.getElementById('nft-info').innerHTML = '<p>Error fetching NFTs. Please try again.</p>';
                    });
                } else {
                    document.getElementById('nft-info').innerHTML = '';
                }
            });

            function displayNFTs(nftItems) {
                const nftInfoDiv = document.getElementById('nft-info');
                nftInfoDiv.innerHTML = '';

                if (!nftItems || nftItems.length === 0) {
                    nftInfoDiv.innerHTML = '<p>No NFTs found.</p>';
                    return;
                }

                nftItems.forEach(nft => {
                    const nftElement = document.createElement('div');
                    nftElement.innerHTML = `
                        <p><strong>Name:</strong> ${nft.metadata?.name || 'No Name'}</p>
                        <p><strong>Description:</strong> ${nft.metadata?.description || 'No Description'}</p>
                        <img src="${nft.metadata?.image || 'placeholder-image-url'}" alt="${nft.metadata?.name || 'NFT'}" style="max-width: 200px;">
                    `;
                    nftInfoDiv.appendChild(nftElement);
                });
            }
        </script>
    </div>
</body>
</html>
